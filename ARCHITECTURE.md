# ??? Arquitetura do Sistema

## ?? Vis?o Geral

Este documento descreve a arquitetura completa do sistema de demonstra??o Kubernetes, incluindo componentes, comunica??o, e decis?es de design.

## ?? Arquitetura de Alto N?vel

```
???????????????????????????????????????????????????????????????????????
?                            Internet / Browser                        ?
???????????????????????????????????????????????????????????????????????
                                 ?
                                 ? HTTP
                                 ?
???????????????????????????????????????????????????????????????????????
?                         macOS Host (/etc/hosts)                      ?
?                     demo.local ? 192.168.49.2                        ?
?                     users-api.local ? 192.168.49.2                   ?
?                     products-api.local ? 192.168.49.2                ?
???????????????????????????????????????????????????????????????????????
                                 ?
                                 ?
???????????????????????????????????????????????????????????????????????
?                         Minikube Cluster                             ?
?  ????????????????????????????????????????????????????????????????   ?
?  ?                    Ingress Controller                         ?   ?
?  ?                  (nginx-ingress)                              ?   ?
?  ?                                                               ?   ?
?  ?  Routes:                                                      ?   ?
?  ?    demo.local/* ? frontend-service:80                        ?   ?
?  ?    users-api.local/* ? users-api-service:80                  ?   ?
?  ?    products-api.local/* ? products-api-service:80            ?   ?
?  ?????????????????????????????????????????????????????????????????   ?
?             ?                  ?                  ?                  ?
?             ?                  ?                  ?                  ?
?  ??????????????????????? ???????????????? ?????????????????????    ?
?  ?  frontend-service   ? ? users-api-   ? ? products-api-     ?    ?
?  ?   (ClusterIP)       ? ?  service     ? ?  service          ?    ?
?  ?   Port: 80          ? ? (ClusterIP)  ? ? (ClusterIP)       ?    ?
?  ??????????????????????? ? Port: 80     ? ? Port: 80          ?    ?
?             ?             ???????????????? ?????????????????????    ?
?             ? Load Balancer    ? Load Balancer    ? Load Balancer  ?
?             ?                  ?                  ?                  ?
?  ??????????????????????? ???????????????? ?????????????????????    ?
?  ?  frontend-pod-1     ? ? users-api-   ? ? products-api-     ?    ?
?  ?  (Angular + Nginx)  ? ?  pod-1       ? ?  pod-1            ?    ?
?  ?  Replicas: 2        ? ? (Laravel+    ? ? (Laravel+         ?    ?
?  ??????????????????????? ?  Apache)     ? ?  Apache)          ?    ?
?  ??????????????????????? ? Replicas: 2  ? ? Replicas: 2       ?    ?
?  ?  frontend-pod-2     ? ???????????????? ?????????????????????    ?
?  ?  (Angular + Nginx)  ? ???????????????? ?????????????????????    ?
?  ??????????????????????? ? users-api-   ? ? products-api-     ?    ?
?                           ?  pod-2       ? ?  pod-2            ?    ?
?                           ???????????????? ?????????????????????    ?
?                                                                      ?
????????????????????????????????????????????????????????????????????????
```

## ?? Componentes

### 1. Frontend (Angular + Nginx)

**Tecnologia:**
- Angular 17 (standalone components)
- TypeScript
- RxJS para programa??o reativa
- Nginx como servidor web

**Responsabilidades:**
- Interface do usu?rio
- Consumir APIs backend
- Roteamento client-side
- Gerenciamento de estado local

**Endpoints:**
- `GET /` - Aplica??o principal

**Container:**
- Base: `node:20-alpine` (build) + `nginx:alpine` (runtime)
- Porta: 80
- Multi-stage build para otimiza??o

**Kubernetes:**
- Deployment: `frontend`
- Replicas: 2
- Service: `frontend-service` (ClusterIP)
- Resources:
  - Requests: 64Mi RAM, 50m CPU
  - Limits: 128Mi RAM, 100m CPU

### 2. Users API (Laravel + PHP)

**Tecnologia:**
- PHP 8.2
- Laravel 10
- Apache HTTP Server
- Composer

**Responsabilidades:**
- Gerenciamento de usu?rios
- Endpoints RESTful
- Health checks
- Dados mockados (demo)

**Endpoints:**
- `GET /api/health` - Health check
- `GET /api/users` - Lista todos usu?rios
- `GET /api/users/{id}` - Busca usu?rio por ID

**Container:**
- Base: `php:8.2-apache`
- Porta: 80
- Extens?es: pdo_mysql, mbstring, exif, pcntl, bcmath, gd

**Kubernetes:**
- Deployment: `users-api`
- Replicas: 2
- Service: `users-api-service` (ClusterIP)
- Resources:
  - Requests: 128Mi RAM, 100m CPU
  - Limits: 256Mi RAM, 200m CPU
- Probes:
  - Liveness: /api/health (30s delay)
  - Readiness: /api/health (5s delay)

### 3. Products API (Laravel + PHP)

**Tecnologia:**
- PHP 8.2
- Laravel 10
- Apache HTTP Server
- Composer

**Responsabilidades:**
- Gerenciamento de produtos
- Endpoints RESTful
- Health checks
- Dados mockados (demo)

**Endpoints:**
- `GET /api/health` - Health check
- `GET /api/products` - Lista todos produtos
- `GET /api/products/{id}` - Busca produto por ID

**Container:**
- Base: `php:8.2-apache`
- Porta: 80
- Extens?es: pdo_mysql, mbstring, exif, pcntl, bcmath, gd

**Kubernetes:**
- Deployment: `products-api`
- Replicas: 2
- Service: `products-api-service` (ClusterIP)
- Resources:
  - Requests: 128Mi RAM, 100m CPU
  - Limits: 256Mi RAM, 200m CPU
- Probes:
  - Liveness: /api/health (30s delay)
  - Readiness: /api/health (5s delay)

### 4. Ingress Controller

**Tecnologia:**
- Nginx Ingress Controller
- Addon do Minikube

**Responsabilidades:**
- Roteamento externo
- Load balancing
- SSL/TLS termination (futuro)
- CORS handling

**Configura??o:**
- Class: `nginx`
- CORS habilitado
- M?ltiplos hosts:
  - `demo.local` ? frontend-service
  - `users-api.local` ? users-api-service
  - `products-api.local` ? products-api-service

## ?? Fluxo de Comunica??o

### Fluxo 1: Usu?rio Acessa Frontend

```
User ? Browser ? demo.local ? Minikube IP ? Ingress ?
frontend-service ? frontend-pod ? Nginx ? Angular App
```

### Fluxo 2: Frontend Consulta Users API

```
Angular App ? HTTP Request ? users-api.local ? Ingress ?
users-api-service ? users-api-pod ? Laravel ? JSON Response
```

### Fluxo 3: Frontend Consulta Products API

```
Angular App ? HTTP Request ? products-api.local ? Ingress ?
products-api-service ? products-api-pod ? Laravel ? JSON Response
```

## ?? Padr?es de Design

### 1. Microservi?os

Cada servi?o ? independente e respons?vel por um dom?nio espec?fico:
- Users API: Dom?nio de usu?rios
- Products API: Dom?nio de produtos
- Frontend: Interface do usu?rio

**Vantagens:**
- Escalabilidade independente
- Deploy independente
- Tecnologias espec?ficas por servi?o
- Isolamento de falhas

### 2. API Gateway (Ingress)

O Ingress atua como API Gateway:
- Ponto ?nico de entrada
- Roteamento baseado em host
- Load balancing autom?tico

### 3. Service Discovery

Kubernetes DNS resolve services automaticamente:
```
<service-name>.<namespace>.svc.cluster.local
```

### 4. Health Checks

Todos os servi?os backend implementam:

**Liveness Probe:**
- Verifica se o container est? vivo
- Se falhar, Kubernetes reinicia o pod

**Readiness Probe:**
- Verifica se o container est? pronto para receber tr?fego
- Se falhar, pod ? removido do Service

### 5. Twelve-Factor App

Aplica??o segue princ?pios do [12-factor](https://12factor.net/):
- ? Codebase: Um c?digo, m?ltiplos deploys
- ? Dependencies: Declaradas explicitamente
- ? Config: Separada do c?digo
- ? Backing services: Tratados como recursos
- ? Build, release, run: Est?gios separados
- ? Processes: Stateless
- ? Port binding: Self-contained
- ? Concurrency: Scale out via processos
- ? Disposability: Fast startup e shutdown
- ? Dev/prod parity: Ambientes similares
- ? Logs: Event streams
- ? Admin processes: One-off tasks

## ?? Recursos Kubernetes

### Namespace

```yaml
namespace: demo-k8s (ou default)
```

Isolamento l?gico dos recursos.

### ConfigMap

Armazena configura??es:
- URLs das APIs
- Environment variables
- Configura??es n?o-sens?veis

### Deployments

Gerencia pods e r?plicas:
- Declarativo
- Rolling updates
- Rollback autom?tico
- Self-healing

### Services

Abstra??o para acesso aos pods:
- ClusterIP: Interno ao cluster
- DNS autom?tico
- Load balancing
- Service discovery

### Ingress

Gerencia acesso externo:
- HTTP routing
- Virtual hosting
- SSL termination
- Path-based routing

## ?? Seguran?a

### Pr?ticas Implementadas

1. **Least Privilege:**
   - Containers n?o rodam como root (onde poss?vel)
   - Resource limits definidos

2. **Network Policies:**
   - Services n?o expostos desnecessariamente
   - ClusterIP para comunica??o interna

3. **Health Checks:**
   - Detectam e recuperam de falhas
   - Previnem pods defeituosos

4. **Image Security:**
   - Multi-stage builds
   - Imagens oficiais como base
   - .dockerignore para excluir arquivos sens?veis

### Melhorias Futuras

- [ ] HTTPS/TLS
- [ ] Secrets para dados sens?veis
- [ ] Network Policies
- [ ] Pod Security Policies
- [ ] RBAC (Role-Based Access Control)
- [ ] Admission Controllers
- [ ] Image scanning

## ?? Escalabilidade

### Horizontal Pod Autoscaling (HPA)

Futuro: Implementar HPA baseado em:
- CPU usage
- Memory usage
- Custom metrics (requests/second)

Exemplo:
```yaml
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: users-api-hpa
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: users-api
  minReplicas: 2
  maxReplicas: 10
  metrics:
  - type: Resource
    resource:
      name: cpu
      target:
        type: Utilization
        averageUtilization: 70
```

### Vertical Pod Autoscaling (VPA)

Futuro: Ajustar automaticamente resources requests/limits.

## ?? Observabilidade

### Logs

Cada pod gera logs que podem ser acessados via:
```bash
kubectl logs <pod-name>
kubectl logs -f <pod-name>  # follow
stern <pattern>              # m?ltiplos pods
```

### M?tricas

Metrics Server habilitado:
```bash
kubectl top nodes
kubectl top pods
```

### Futuro: Monitoring Stack

Implementar:
- Prometheus: M?tricas
- Grafana: Visualiza??o
- Alertmanager: Alertas
- Jaeger: Tracing distribu?do

## ?? CI/CD

### Pipeline Sugerido

```
???????????????
?   Git Push  ?
???????????????
       ?
       ?
???????????????
?   Build     ? ? Docker build
???????????????
       ?
       ?
???????????????
?   Test      ? ? Unit tests
???????????????
       ?
       ?
???????????????
?  Push Image ? ? Docker registry
???????????????
       ?
       ?
???????????????
?   Deploy    ? ? kubectl apply
???????????????
```

Ferramentas:
- GitHub Actions
- GitLab CI
- Jenkins
- ArgoCD (GitOps)

## ?? Decis?es de Arquitetura

### Por que Microservi?os?

**Pr?s:**
- Demonstra conceitos distribu?dos
- Escalabilidade independente
- Tecnologias espec?ficas
- Isolamento de falhas

**Contras:**
- Complexidade adicional
- Overhead de rede
- Debugging mais dif?cil

Para produ??o: Avaliar se monolito modular n?o seria melhor.

### Por que Kubernetes?

**Pr?s:**
- Orquestra??o autom?tica
- Self-healing
- Service discovery
- Declarativo
- Port?vel

**Contras:**
- Curva de aprendizado
- Overhead operacional
- Complexidade

Para este projeto: Perfeito para demonstra??o educacional.

### Por que Minikube?

**Pr?s:**
- Cluster local completo
- F?cil setup
- Addons ?teis
- Gratuito

**Contras:**
- Limita??es de recursos
- N?o ? produ??o

Alternativas: kind, k3s, Docker Desktop Kubernetes.

## ?? Atualiza??es e Rollback

### Rolling Update

Padr?o do Kubernetes:
```yaml
strategy:
  type: RollingUpdate
  rollingUpdate:
    maxUnavailable: 1
    maxSurge: 1
```

### Rollback

```bash
# Ver hist?rico
kubectl rollout history deployment/users-api

# Rollback
kubectl rollout undo deployment/users-api

# Rollback para revis?o espec?fica
kubectl rollout undo deployment/users-api --to-revision=2
```

## ?? Refer?ncias

- [Kubernetes Documentation](https://kubernetes.io/docs/)
- [12-Factor App](https://12factor.net/)
- [Microservices Patterns](https://microservices.io/)
- [Docker Best Practices](https://docs.docker.com/develop/dev-best-practices/)
- [Laravel Documentation](https://laravel.com/docs)
- [Angular Documentation](https://angular.io/docs)

---

**?ltima atualiza??o:** 2024

*Arquitetura de Microservi?os com Kubernetes*
