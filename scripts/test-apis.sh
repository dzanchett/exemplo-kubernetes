#!/bin/bash

###############################################################################
# Script para testar as APIs
###############################################################################

# Cores
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
RED='\033[0;31m'
NC='\033[0m'

echo -e "${BLUE}"
echo "??????????????????????????????????????????????????????????????"
echo "?                  Teste das APIs - Kubernetes               ?"
echo "??????????????????????????????????????????????????????????????"
echo -e "${NC}"

# Fun??o para testar endpoint
test_endpoint() {
    local name=$1
    local url=$2
    
    echo -e "\n${YELLOW}?? Testando: ${name}${NC}"
    echo -e "${BLUE}URL: ${url}${NC}"
    
    response=$(curl -s -w "\n%{http_code}" "$url")
    http_code=$(echo "$response" | tail -n1)
    body=$(echo "$response" | head -n-1)
    
    if [ "$http_code" -eq 200 ]; then
        echo -e "${GREEN}? Status: ${http_code} OK${NC}"
        echo -e "${GREEN}Response:${NC}"
        echo "$body" | python3 -m json.tool 2>/dev/null || echo "$body"
    else
        echo -e "${RED}? Status: ${http_code} ERRO${NC}"
        echo "$body"
    fi
}

# Testar Users API
echo -e "\n${BLUE}??????????????????????????????????????????????????????????${NC}"
echo -e "${BLUE}                      USERS API                            ${NC}"
echo -e "${BLUE}??????????????????????????????????????????????????????????${NC}"

test_endpoint "Health Check - Users API" "http://users-api.local/api/health"
test_endpoint "Lista de Usu?rios" "http://users-api.local/api/users"
test_endpoint "Usu?rio Espec?fico (ID: 1)" "http://users-api.local/api/users/1"

# Testar Products API
echo -e "\n${BLUE}??????????????????????????????????????????????????????????${NC}"
echo -e "${BLUE}                    PRODUCTS API                           ${NC}"
echo -e "${BLUE}??????????????????????????????????????????????????????????${NC}"

test_endpoint "Health Check - Products API" "http://products-api.local/api/health"
test_endpoint "Lista de Produtos" "http://products-api.local/api/products"
test_endpoint "Produto Espec?fico (ID: 1)" "http://products-api.local/api/products/1"

# Testar Frontend
echo -e "\n${BLUE}??????????????????????????????????????????????????????????${NC}"
echo -e "${BLUE}                       FRONTEND                            ${NC}"
echo -e "${BLUE}??????????????????????????????????????????????????????????${NC}"

echo -e "\n${YELLOW}?? Testando: Frontend${NC}"
echo -e "${BLUE}URL: http://demo.local${NC}"

response=$(curl -s -w "\n%{http_code}" "http://demo.local")
http_code=$(echo "$response" | tail -n1)

if [ "$http_code" -eq 200 ]; then
    echo -e "${GREEN}? Status: ${http_code} OK${NC}"
    echo -e "${GREEN}Frontend est? acess?vel!${NC}"
else
    echo -e "${RED}? Status: ${http_code} ERRO${NC}"
fi

echo -e "\n${GREEN}"
echo "??????????????????????????????????????????????????????????????"
echo "?              ? Testes Conclu?dos!                          ?"
echo "??????????????????????????????????????????????????????????????"
echo -e "${NC}"

echo -e "\n${YELLOW}?? Acesse no navegador:${NC}"
echo -e "${GREEN}http://demo.local${NC}"
echo ""
